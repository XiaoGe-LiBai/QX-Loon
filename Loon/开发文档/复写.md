# 复写

复写是专门用来处理 HTTP/S 类型的请求，在请求未发出前和获取响应后，根据所设定的复写类型来修改请求数据，可修改请求的 URL、Header、Body 以及响应的 Header、Body，**所有的复写仅在 http 请求或者经过解密后的 https 请求中有效**

**复写的处理会在规则匹配之前**

匹配优先级[​](#匹配优先级 "Direct link to 匹配优先级")
---------------------------------------

和规则的优先级一样，**本地配置文件中的复写 > 插件中的复写**，相同文件中的复写，优先级**自上而下越来越低**。

多次匹配[​](#多次匹配 "Direct link to 多次匹配")
------------------------------------

Loon 的复写对一个 HTTP/S 的两侧进行作用，请求侧和响应侧，两侧复写会分别进行匹配，请求侧和响应侧复写可以作用于同一个 HTTP/S 中。从 3.2.3（749）开始多个同一侧的复写可以作用于一个 HTTP/S 中，前提是多个同侧复写的正则表达式要一致，如果使用不同的正则表达式却可以匹配同一个 url，那优先级高的那个复写才会起作用，所以**如果要多个同侧复写作用于一个 HTTP/S，请使用相同的正则表达式进行匹配**。

### 多次匹配注意事项[​](#多次匹配注意事项 "Direct link to 多次匹配注意事项")

*   不同侧的复写可以同时匹配一个 HTTP/S
*   多个同侧复写匹配时，采用的修改方式是叠加修改，即**第一个复写修改的输出作为第二个修改的输入**，所以如果修改的内容相同，后面的会覆盖前面的修改

URL 类型复写[​](#url-类型复写 "Direct link to URL 类型复写")
------------------------------------------------

此类复写会修改请求的 URL

```
^http://www\.google\.cn header http://www.google.com
```

直接响应类复写[​](#直接响应类复写 "Direct link to 直接响应类复写")
---------------------------------------------

此类复写直接返回一个 code 位 30x 的重定向 response

### 302[​](#302 "Direct link to 302")

```
^http://example.com 302 https://example.com
```

### 307[​](#307 "Direct link to 307")

```
^http://example.com 307 https://example.com
```

### reject[​](#reject "Direct link to reject")

1.  **reject**: 直接断开连接
2.  **reject-200**: 返回一个 code 为 200，body 内容为空的 response
3.  **reject_img**: 返回一个 code 为 200，body 内容一像素图片的的 response
4.  **reject_dict**: 返回一个 code 为 200，body 内容为`"{}"`的空 json 对象字符串
5.  **reject_array**: 返回一个 code 为 200，body 内容为`"[]"`的空 json 数组字符串

```
^http://example.com reject ^http://example.com reject-200 ^http://example.com reject-img ^http://example.com reject-dict ^http://example.com reject-array
```

此类复写会修改请求的 Header

```
^http://example.com header-add Connection keep-alive ^http://example.com header-del Cookie ^http://example.com header-replace User-Agent Unknown ^http://example.com header-replace-regex User-Agent regex replace-value //替换User-Agent的值被正则regex匹配到的内容
```

**注意：由于在解析配置是用空格分割各个参数，如果配置的参数中有空格，请使用`\x20`代替**

从 3.2.1(build 730) 开始，可以给一个 Request Header 类型的 Rewrite 设置修改多个值，如：

```
^http://example.com header-add Connection keep-alive Proxy-Connection keep-alive //header中添加Connection:keep-alive和Proxy-Connection:keep-alive ^http://example.com header-del Cookie Connection ^http://example.com header-replace User-Agent Unknown Content-Length 1999 Content-Type application/json ^http://example.com header-replace-regex User-Agent regex replace-value Cookie UUID=123 UUID=456
```

Request Body 类型复写 (build 729+)[​](#request-body-类型复写-build-729 "Direct link to Request Body 类型复写 (build 729+)")
---------------------------------------------------------------------------------------------------------------

此类复写会修改请求体

```
^http://example.com request-body-replace-regex regex1 replace-value1 regex2 replace-value2^http://example.com request-body-json-add data.apps[0] {"appName":"loon","appVersion":"3.2.1"} data.category tool^http://example.com request-body-json-replace data.ad {}^http://example.com request-body-json-del data.ad^http://example.com request-body-json-jq 'del(.data.ad)'
```

request-body-json-xxx 类型的复写只有当请求体是 Json 格式时才会有效，提供一个定位到要处理的 json 对象的 keypath 即可添加、删除、替换相关 json 对象，keypath 采用点分式，如 `data.apps[0].appname`,`[0]`表示数组第一个对象，如果 keypath 无法定位到 json 对象的子对象，或者数组越界，keypath 无效。request-body-json-jq 使用 jq 表达式来修改 json 数据，使用单引号包裹 jq 表达式，jq 语法详见：[https://jqlang.github.io/jq/tutorial/](https://jqlang.github.io/jq/tutorial/)

Mock Request Body[​](#mock-request-body "Direct link to Mock Request Body")
---------------------------------------------------------------------------

此类复写使用一个假数据模拟 Http request body

```
^http://example.com mock-request-body data-type=text data="" ^http://example.com mock-request-body data-type=json data-path=request_body.json^http://example.com mock-request-body data-type=png data-path=request_body.raw mock-data-is-base64=true
```

*   data-type: body 的类型，`json`,`text`,`css`,`html`,`javascript`,`plain`,`png`,`gif`,`jpeg`,`tiff`,`svg`,`mp4`,`form-data`
*   data: body 的值，用双引号包裹，**由于 data 会加载到内存中，建议采用 data-path 的方式配置中大型的 Mock Data**
*   data-path: body 的文件路径，用双引号包裹，可以是 url，也可以是 iCloud/Mock 路径下的文件全名
*   mock-data-is-base64：如果 data 或者 data-path 提供的数据是二进制的 base64 字符串，设置此配置为 true

此类复写会修改响应的 Header

```
^http://example.com response-header-add Connection keep-alive ^http://example.com response-header-del Cookie ^http://example.com response-header-replace User-Agent Unknown ^http://example.com response-header-replace-regex User-Agent regex replace-value
```

同 Reqeust Header，从 3.2.1(build 730) 开始可以配置多个 key-value 修改 Response Header

Response Body 类型复写 (build 729+)[​](#response-body-类型复写-build-729 "Direct link to Response Body 类型复写 (build 729+)")
------------------------------------------------------------------------------------------------------------------

此类复写会修改响应体

```
^http://example.com response-body-replace-regex regex1 replace-value1 regex2 replace-value2^http://example.com response-body-json-add data.apps[0] {"appName":"loon","appVersion":"3.2.1"} data.category tool^http://example.com response-body-json-replace data.ad {}^http://example.com response-body-json-del data.ad^http://example.com response-body-json-jq 'del(.data.ad)'
```

response-body-json-xxx 类型的复写只有当响应体是 Json 格式时才会有效，提供一个定位到需要处理的 json 对象的 keypath 即可添加、删除、替换相关 json 对象，keypath 采用点分式，如 `data.apps[0].appname`,`[0]`表示数组第一个对象，如果 keypath 无法定位到 json 对象的子对象，或者数组越界，keypath 无效。response-body-json-jq 使用 jq 表达式来修改 json 数据，使用单引号包裹 jq 表达式，jq 语法详见：[https://jqlang.github.io/jq/tutorial/](https://jqlang.github.io/jq/tutorial/)

Mock Response Body[​](#mock-response-body "Direct link to Mock Response Body")
------------------------------------------------------------------------------

此类复写立即返回一个 Http response body

```
^http://example.com mock-response-body data-type=text data="" status-code=200^http://example.com mock-response-body data-type=json data-path=response_body.json status-code=200^http://example.com mock-response-body data-type=svg data-path=response_body.raw mock-data-is-base64=true status-code=200
```

*   data-type: body 的类型，`json`,`text`,`css`,`html`,`javascript`,`plain`,`png`,`gif`,`jpeg`,`tiff`,`svg`,`mp4`,`form-data`
*   data: body 的值，用双引号包裹，**由于 data 会加载到内存中，建议采用 data-path 的方式配置中大型的 Mock Data**
*   data-path: body 的文件路径，用双引号包裹，可以是 url，也可以是 iClcoud/Mock 路径下的文件全名
*   status-code: Http response status code
*   mock-data-is-base64：如果 data 或者 data-path 提供的数据是二进制的 base64 字符串，设置此配置为 true
*   status-code: Http response status code

**⚠️⚠️⚠️注意⚠️⚠️⚠️**

**如果正则表达式或者替换的内容包含空格，请使用`\x20`表示，否则 rewrite 配置会解析异常**

**如果正则表达式或者替换的内容包含空格，请使用`\x20`表示，否则 rewrite 配置会解析异常**

**如果正则表达式或者替换的内容包含空格，请使用`\x20`表示，否则 rewrite 配置会解析异常**